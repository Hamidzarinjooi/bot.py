import requests
import os
import shutil
import asyncio # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ø®Ø·
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, CallbackQueryHandler, ContextTypes, filters

# Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ùˆ ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ú©Ø§Ù†Ø§Ù„
TOKEN = "7649603433:AAGFPz0GcOW2Ym0e2iHMGrELEFEEpidwtrE"
CHANNEL_USERNAME = "@cafe_nexivo"

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Apify ---
# Ø´Ù†Ø§Ø³Ù‡ Actor Ø¨Ø±Ø§ÛŒ Instagram Post Scraper Ø¯Ø± Apify (Ø§Ø² URL Ú©Ù†Ø³ÙˆÙ„ Apify Ø´Ù…Ø§)
APIFY_ACTOR_ID = "shu8hvrXbJbY3Eb9W"
# API Token Ø´Ù…Ø§ Ø§Ø² Apify
APIFY_API_TOKEN = "apify_api_wDwmXn4BMbag5GcljUgdw7r6zZSr2K39rnEo"

# Ù†Ù‚Ø·Ù‡ Ù¾Ø§ÛŒØ§Ù†ÛŒ Apify Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Actor Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬ Ø¨Ù‡ ØµÙˆØ±Øª Ù‡Ù…Ø²Ù…Ø§Ù†
APIFY_ENDPOINT = f"https://api.apify.com/v2/acts/{APIFY_ACTOR_ID}/run-sync-get-dataset-items"

# ===========================
# ØªÙˆØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ú©ÛŒØ¨ÙˆØ±Ø¯
def get_main_keyboard():
    keyboard = [
        [InlineKeyboardButton("Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ ğŸ“¢", url=f"https://t.me/{CHANNEL_USERNAME.lstrip('@')}")],
        [InlineKeyboardButton("Ø¹Ø¶Ùˆ Ø´Ø¯Ù… âœ…", callback_data="check_membership")],
        [InlineKeyboardButton("Ø±Ø§Ù‡Ù†Ù…Ø§ â„¹ï¸", callback_data="help")]
    ]
    return InlineKeyboardMarkup(keyboard)

# ===========================
# ØªÙˆØ§Ø¨Ø¹ Ù‡Ù†Ø¯Ù„Ø± Ø¯Ø³ØªÙˆØ±Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ‘‹ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆÛŒ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ!\n\nğŸ“Œ Ù„Ø·ÙØ§Ù‹ Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ù…Ø§ Ø´Ùˆ Ùˆ Ø±ÙˆÛŒ 'Ø¹Ø¶Ùˆ Ø´Ø¯Ù… âœ…' Ú©Ù„ÛŒÚ© Ú©Ù†.",
        reply_markup=get_main_keyboard()
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "â„¹ï¸ Ø§ÛŒÙ† Ø±Ø¨Ø§Øª ÙÙ‚Ø· Ù„ÛŒÙ†Ú© Ù¾Ø³Øª ÛŒØ§ Ø±ÛŒÙ„Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø±Ùˆ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù‡ Ùˆ Ø§Ú¯Ø± ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ Ø¨Ø§Ø´Ù‡ØŒ ÙˆØ§Ø³Øª Ø¯Ø§Ù†Ù„ÙˆØ¯Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ù‡.\n\n"
        "â—ï¸Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ø¨Ø§Ø´ÛŒ."
    )

# ===========================
# ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ú©Ø§Ù†Ø§Ù„
async def check_membership(user_id, context):
    try:
        member = await context.bot.get_chat_member(CHANNEL_USERNAME, user_id)
        return member.status in ['member', 'administrator', 'creator']
    except Exception as e:
        print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª: {e}")
        return False

# ===========================
# Ù‡Ù†Ø¯Ù„Ø± Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id

    if query.data == "check_membership":
        if await check_membership(user_id, context):
            await query.edit_message_text("âœ… Ø¹Ø¶ÙˆÛŒØª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯! Ø­Ø§Ù„Ø§ Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆÛŒ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø±Ùˆ Ø¨ÙØ±Ø³Øª.")
        else:
            await query.edit_message_text("â›”ï¸ Ù‡Ù†ÙˆØ² Ø¹Ø¶Ùˆ Ù†Ø´Ø¯ÛŒ. Ù„Ø·ÙØ§Ù‹ Ø¹Ø¶Ùˆ Ø´Ùˆ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†.", reply_markup=get_main_keyboard())

    elif query.data == "help":
        await query.edit_message_text(
            "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª:\n\n"
            "1ï¸âƒ£ Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ø´Ùˆ\n"
            "2ï¸âƒ£ Ù„ÛŒÙ†Ú© Ù¾Ø³Øª ÛŒØ§ Ø±ÛŒÙ„Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø±Ùˆ Ø¨ÙØ±Ø³Øª\n"
            "3ï¸âƒ£ Ø§Ú¯Ù‡ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§Ø´Ù‡ØŒ ÙˆØ§Ø³Øª Ù…ÛŒâ€ŒÙØ±Ø³ØªÙ‡!\n\n"
            "ğŸŒ€ ÙÙ‚Ø· Ù¾Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ù‚Ø§Ø¨Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù‡Ø³ØªÙ†.",
            reply_markup=get_main_keyboard()
        )

# ===========================
# Ù‡Ù†Ø¯Ù„Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ)
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    chat_id = update.message.chat_id
    text = update.message.text.strip()

    if not await check_membership(user_id, context):
        await update.message.reply_text("â›”ï¸ Ø¨Ø§ÛŒØ¯ Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ø¨Ø§Ø´ÛŒ.", reply_markup=get_main_keyboard())
        return

    if "instagram.com" not in text:
        await update.message.reply_text("ğŸ”— Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ù„ÛŒÙ†Ú© Ù¾Ø³Øª ÛŒØ§ Ø±ÛŒÙ„Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø±Ùˆ Ø¨ÙØ±Ø³Øª.")
        return

    # Ù¾ÛŒØ§Ù… "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´" Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ùˆ Ø´Ù†Ø§Ø³Ù‡ Ø¢Ù† Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    processing_message = await update.message.reply_text("â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú© Ø´Ù…Ø§...")
    processing_message_id = processing_message.message_id

    try:
        apify_input = {
            "directUrls": [text],
            "resultsLimit": 1
        }

        response = requests.post(
            url=APIFY_ENDPOINT,
            params={"token": APIFY_API_TOKEN},
            json=apify_input,
            timeout=120
        )
        response.raise_for_status()

        data = response.json()
        video_url = None

        if data and isinstance(data, list) and len(data) > 0:
            first_result = data[0]
            if "videoUrl" in first_result and first_result["videoUrl"]:
                video_url = first_result["videoUrl"]
            elif "displayUrl" in first_result and first_result["displayUrl"] and first_result.get("type") == "Video":
                video_url = first_result["displayUrl"]

        if video_url:
            # Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ù†Ø§Ø³Ù‡ Ù¾ÛŒØ§Ù… Ø¢Ù†
            sent_video_message = await update.message.reply_video(video_url)
            sent_video_message_id = sent_video_message.message_id

            # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØªØ§ÛŒÛŒØ¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ù†Ø§Ø³Ù‡ Ù¾ÛŒØ§Ù… Ø¢Ù†
            confirmation_message = await update.message.reply_text("âœ… ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ùˆ ÙˆÛŒØ¯ÛŒÙˆÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ Ù¾Ø³ Ø§Ø² 30 Ø«Ø§Ù†ÛŒÙ‡ Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.")
            confirmation_message_id = confirmation_message.message_id

            # Ø­Ø°Ù Ù¾ÛŒØ§Ù… "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´"
            await context.bot.delete_message(chat_id=chat_id, message_id=processing_message_id)

            # Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© ØªØ³Ú© ØºÛŒØ±Ù…Ø³Ø¯ÙˆØ¯Ú©Ù†Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù¾Ø³ Ø§Ø² 30 Ø«Ø§Ù†ÛŒÙ‡
            asyncio.create_task(delete_messages_after_delay(
                context,
                chat_id,
                [sent_video_message_id, confirmation_message_id, update.message.message_id] # Ù¾ÛŒØ§Ù… ÙˆÛŒØ¯ÛŒÙˆØŒ Ù¾ÛŒØ§Ù… ØªØ§ÛŒÛŒØ¯ Ùˆ Ù¾ÛŒØ§Ù… Ø§ØµÙ„ÛŒ Ú©Ø§Ø±Ø¨Ø±
            ))

        else:
            await update.message.reply_text("âŒ ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ÛŒØ§ Apify Ù¾Ø§Ø³Ø® Ù…Ø¹ØªØ¨Ø±ÛŒ Ù†Ø¯Ø§Ø¯. Ø´Ø§ÛŒØ¯ Ù¾Ø³Øª ÙˆÛŒØ¯ÛŒÙˆ Ù†Ø¨Ø§Ø´Ø¯ØŒ Ø®ØµÙˆØµÛŒ Ø¨Ø§Ø´Ø¯ ÛŒØ§ Apify Ù‚Ø§Ø¯Ø± Ø¨Ù‡ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢Ù† Ù†ÛŒØ³Øª.")

    except requests.exceptions.RequestException as req_err:
        await update.message.reply_text(f"ğŸš« Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆÛŒØ³ Ø¯Ø§Ù†Ù„ÙˆØ¯ (Apify): {req_err}")
        print(f"âš ï¸ Ø®Ø·Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª HTTP Ø§Ø² Apify: {req_err}")
    except ValueError:
        await update.message.reply_text("ğŸš« Ø®Ø·Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ø§Ø² Apify. Ù¾Ø§Ø³Ø® Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.")
        print(f"âš ï¸ Ø®Ø·Ø§ÛŒ JSON Ø§Ø² Apify: {response.text}")
    except Exception as e:
        await update.message.reply_text("ğŸš« Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ù†Ù„ÙˆØ¯.")
        print(f"âš ï¸ Ø®Ø·Ø§: {e}")
    finally:
        # Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø±ÙˆØ² Ø®Ø·Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ØŒ Ù¾ÛŒØ§Ù… "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´" Ø±Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=processing_message_id)
        except Exception:
            pass # Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„Ø§Ù‹ Ù¾Ø§Ú© Ø´Ø¯Ù‡ ÛŒØ§ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…


# ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù¾Ø³ Ø§Ø² ØªØ§Ø®ÛŒØ±
async def delete_messages_after_delay(context: ContextTypes.DEFAULT_TYPE, chat_id: int, message_ids: list, delay_seconds: int = 30):
    await asyncio.sleep(delay_seconds)
    for msg_id in message_ids:
        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=msg_id)
        except Exception as e:
            # Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„Ø§Ù‹ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ù¾Ø§Ú© Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ ÛŒØ§ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ù‡Ø¯
            print(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… {msg_id} Ø¯Ø± Ú†Øª {chat_id}: {e}")

# ===========================
# ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª
def main():
    application = ApplicationBuilder().token(TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    application.add_handler(CallbackQueryHandler(button_handler))

    print("Ø±Ø¨Ø§Øª Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª...")
    application.run_polling()

if __name__ == "__main__":
    main()
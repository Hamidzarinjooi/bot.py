from pyrogram import Client, errors, filters
from pyrogram.enums import ChatType
from re import match, IGNORECASE, findall
import asyncio
from apscheduler.schedulers.asyncio import AsyncIOScheduler

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù„Ø§ÛŒÙ†Øª ---
API_ID = 5888972
API_HASH = "8c6c75ac3bb436c548e56e93020cb738"
# Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø®ÙˆØ¯Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø­ØªÙ…Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†
OWNER_ID = 5750772614 

app = Client("iphone_11_pro", api_id=API_ID, api_hash=API_HASH)
scheduler = AsyncIOScheduler({'apscheduler.job_defaults.max_instances': 2})

# --- Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø³Ø§Ø¯Ù‡ ---
db = {
    "admins": [OWNER_ID],
    "ad_group_status": "off",
    "ad_pv_status": "off",
    "timer_group": 10,
    "timer_pv": 10,
    "group_banner": {"chat_id": None, "msg_id": None},
    "pv_banner": {"chat_id": None, "msg_id": None}
}

# --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
def is_admin(_, __, message):
    return message.from_user and message.from_user.id in db["admins"]

admin_filter = filters.create(is_admin)

# --- Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± ---
async def bannerG_handler():
    if db["ad_group_status"] == "on" and db["group_banner"]["msg_id"]:
        async for dialog in app.get_dialogs():
            if dialog.chat.type in [ChatType.SUPERGROUP, ChatType.GROUP]:
                try:
                    await app.copy_message(
                        chat_id=dialog.chat.id,
                        from_chat_id=db["group_banner"]["chat_id"],
                        message_id=db["group_banner"]["msg_id"]
                    )
                    await asyncio.sleep(15)
                except Exception: continue

async def bannerP_handler():
    if db["ad_pv_status"] == "on" and db["pv_banner"]["msg_id"]:
        async for dialog in app.get_dialogs():
            if dialog.chat.type == ChatType.PRIVATE and dialog.chat.id not in db["admins"]:
                try:
                    await app.copy_message(
                        chat_id=dialog.chat.id,
                        from_chat_id=db["pv_banner"]["chat_id"],
                        message_id=db["pv_banner"]["msg_id"]
                    )
                    await asyncio.sleep(15)
                except Exception: continue

# --- Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ ---
@app.on_message(admin_filter)
async def user_message_handler(client, message):
    text = message.text or ""
    
    # Ø¯Ø³ØªÙˆØ±Ø§Øª ÙˆØ¶Ø¹ÛŒØª
    if match(r'^(Stats|ÙˆØ¶Ø¹ÛŒØª|Ping|Ø±Ø¨Ø§Øª)$', text, IGNORECASE):
        status_text = (
            f"ğŸ› ÙˆØ¶Ø¹ÛŒØª ØªØ¨Ú†ÛŒ HxD :\n\n"
            f"â—„ ØªØ¨Ù„ÛŒØº Ø¯Ø± Ú¯Ø±ÙˆÙ‡ : {db['ad_group_status']}\n"
            f"â—„ ØªØ¨Ù„ÛŒØº Ø¯Ø± Ù¾ÛŒÙˆÛŒ : {db['ad_pv_status']}\n"
            f"â—„ ØªØ§ÛŒÙ… Ú¯Ø±ÙˆÙ‡ : {db['timer_group']} Ø¯Ù‚ÛŒÙ‚Ù‡\n"
            f"â—„ ØªØ§ÛŒÙ… Ù¾ÛŒÙˆÛŒ : {db['timer_pv']} Ø¯Ù‚ÛŒÙ‚Ù‡\n"
            f"â—„ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ : {len(db['admins'])}"
        )
        await message.reply_text(status_text)

    # ØªÙ†Ø¸ÛŒÙ… Ø¨Ù†Ø±Ù‡Ø§ (Reply)
    elif message.reply_to_message and match(r'^(Set ad group|ØªÙ†Ø¸ÛŒÙ… ØªØ¨Ù„ÛŒØº Ú¯Ø±ÙˆÙ‡)$', text, IGNORECASE):
        db["group_banner"] = {"chat_id": message.chat.id, "msg_id": message.reply_to_message.id}
        await message.reply_text("âœ… Ø¨Ù†Ø± Ú¯Ø±ÙˆÙ‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.")

    elif message.reply_to_message and match(r'^(Set ad pv|ØªÙ†Ø¸ÛŒÙ… ØªØ¨Ù„ÛŒØº Ù¾ÛŒÙˆÛŒ)$', text, IGNORECASE):
        db["pv_banner"] = {"chat_id": message.chat.id, "msg_id": message.reply_to_message.id}
        await message.reply_text("âœ… Ø¨Ù†Ø± Ù¾ÛŒÙˆÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.")

    # Ø±ÙˆØ´Ù†/Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù†
    elif match(r'^(Adgroup on|ØªØ¨Ù„ÛŒØº Ø¯Ø± Ú¯Ø±ÙˆÙ‡ Ø±ÙˆØ´Ù†)$', text, IGNORECASE):
        db["ad_group_status"] = "on"
        await message.reply_text("ğŸš€ ØªØ¨Ù„ÛŒØº Ø®ÙˆØ¯Ú©Ø§Ø± Ú¯Ø±ÙˆÙ‡ Ø±ÙˆØ´Ù† Ø´Ø¯.")

    elif match(r'^(Adgroup off|ØªØ¨Ù„ÛŒØº Ø¯Ø± Ú¯Ø±ÙˆÙ‡ Ø®Ø§Ù…ÙˆØ´)$', text, IGNORECASE):
        db["ad_group_status"] = "off"
        await message.reply_text("ğŸ›‘ ØªØ¨Ù„ÛŒØº Ø®ÙˆØ¯Ú©Ø§Ø± Ú¯Ø±ÙˆÙ‡ Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯.")

    # Ø¬ÙˆÛŒÙ† Ø®ÙˆØ¯Ú©Ø§Ø±
    elif match(r'^(Join|Ù¾ÛŒÙˆØ³ØªÙ†)$', text, IGNORECASE) and message.reply_to_message:
        links = findall(r"https?://(?:t\.me|telegram\.me)/\S+", message.reply_to_message.text)
        await message.reply_text(f"â³ Ø¯Ø± Ø­Ø§Ù„ Ø¬ÙˆÛŒÙ† Ø¯Ø± {len(links)} Ù„ÛŒÙ†Ú©...")
        for link in links:
            try:
                await client.join_chat(link)
                await asyncio.sleep(30)
            except: continue
        await message.reply_text("âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ù¾ÛŒÙˆØ³ØªÙ† ØªÙ…Ø§Ù… Ø´Ø¯.")

    # Ø±Ø§Ù‡Ù†Ù…Ø§
    elif match(r'^(Help|Ø±Ø§Ù‡Ù†Ù…Ø§)$', text, IGNORECASE):
        await message.reply_text("ğŸ“š Ù„ÛŒØ³Øª Ø¯Ø³ØªÙˆØ±Ø§Øª:\n- ÙˆØ¶Ø¹ÛŒØª\n- ØªÙ†Ø¸ÛŒÙ… ØªØ¨Ù„ÛŒØº Ú¯Ø±ÙˆÙ‡ (Ø±ÙˆÛŒ Ø¨Ù†Ø± Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ú©Ù†)\n- ØªØ¨Ù„ÛŒØº Ø¯Ø± Ú¯Ø±ÙˆÙ‡ Ø±ÙˆØ´Ù†/Ø®Ø§Ù…ÙˆØ´\n- Ù¾ÛŒÙˆØ³ØªÙ† (Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ú©Ù†)")

# --- Ø§Ø¬Ø±Ø§ÛŒ Ø§ØµÙ„ÛŒ ---
async def start_bot():
    await app.start()
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ±Ù‡ Ø§ÛŒ Ø¨Ù‡ Ø§Ø³Ú©ÙˆÙ„Ø±
    scheduler.add_job(bannerG_handler, 'interval', minutes=db["timer_group"], id="group_job")
    scheduler.add_job(bannerP_handler, 'interval', minutes=db["timer_pv"], id="pv_job")
    scheduler.start()
    print("--- BOT IS ONLINE ---")
    await asyncio.Event().wait()

if __name__ == "__main__":
    app.run(start_bot())
